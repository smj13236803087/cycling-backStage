// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
}

model User {
  id                   String               @id @default(uuid())
  displayName          String
  email                String               @unique
  avatar               String?
  password             String?
  gender               Gender?
  role                 Role                 @default(USER)
  status               String               @default("ACTIVE")
  age                  Int?
  region               String?
  birthday             String?
  height               Float?
  weight               Float?
  createdTime          DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  rideRecordRoutes     RideRecordRoute[]
  rideStatistics       RideStatistics[]
  manualCreatedRoutes  ManualCreatedRoute[]
  publishRoutes        UserPublishRoute[]
  followers            UserFollow[]         @relation("UserFollowers") // 关注我的人
  following            UserFollow[]         @relation("UserFollowing") // 我关注的人
  routeLikes           RouteLike[] // 我点赞的路线
  stravaAccessToken    String? // Strava OAuth access token
  stravaRefreshToken   String? // Strava OAuth refresh token
  stravaTokenExpiresAt DateTime? // Strava token过期时间
  stravaAthleteId      String? // Strava athlete ID
}

model RideRecordRoute {
  id               String   @id @default(uuid())
  startCoordinate  String
  endCoordinate    String
  startAddress     String
  endAddress       String
  createdTime      DateTime @default(now())
  distance         Float // 单位：米
  duration         Float // 单位：秒
  elevation        Float?
  avgSpeed         Float?
  maxAvgSpeed      Float? // 最大速度
  route            Json? // 改为可选，存储坐标点数组（[{lat, lng}, ...]）
  uphillDistance   Float?
  downhillDistance Float?
  flatDistance     Float?
  avgAltitude      Float?
  maxAltitude      Float?
  heatConsumption  Float?
  stravaActivityId String? // Strava活动ID，用于跟踪是否已上传
  userId           String
  user             User     @relation(fields: [userId], references: [id])
}

model RideStatistics {
  id               String   @id @default(uuid())
  startCoordinate  String
  endCoordinate    String
  startAddress     String
  endAddress       String
  createdTime      DateTime @default(now())
  distance         Float // 单位：米
  duration         Float // 单位：秒
  elevation        Float?
  avgSpeed         Float?
  maxAvgSpeed      Float? // 最大速度
  route            Json? // 改为可选，存储坐标点数组（[{lat, lng}, ...]）
  uphillDistance   Float?
  downhillDistance Float?
  flatDistance     Float?
  avgAltitude      Float?
  maxAltitude      Float?
  heatConsumption  Float?
  stravaActivityId String? // Strava活动ID，用于跟踪是否已上传
  userId           String
  user             User     @relation(fields: [userId], references: [id])
}

model ManualCreatedRoute {
  id              String   @id @default(uuid())
  createdTime     DateTime @default(now())
  startName       String
  startCoord      String
  endName         String
  endCoord        String
  waypoints       Json? // [{lat, lng}, ...]
  distance        Float
  duration        String
  encodedPolyline String? // Google Maps Polyline
  mainRoute       Json?
  waypointRoutes  Json?
  heatConsumption Float?
  route           Json?
  userId          String
  user            User     @relation(fields: [userId], references: [id])
}

model UserPublishRoute {
  id               String      @id @default(uuid())
  createdTime      DateTime    @default(now())
  startName        String
  startCoord       String
  endName          String
  endCoord         String
  waypoints        Json? // [{lat, lng}, ...]
  distance         Float // 公里
  duration         String // "1小时20分钟" 这种格式
  encodedPolyline  String? // Polyline 编码
  mainRoute        Json? // [{lat,lng}]
  waypointRoutes   Json? // [[{lat,lng}], ...]
  route            Json? // 轨迹点
  heatConsumption  Float? // 卡路里消耗
  elevation        Float? // 爬升高度
  avgSpeed         Float? // 平均速度
  uphillDistance   Float? // 上坡距离
  downhillDistance Float? // 下坡距离
  flatDistance     Float? // 平路距离
  avgAltitude      Float? // 平均海拔
  maxAltitude      Float? // 最大海拔
  userId           String
  user             User        @relation(fields: [userId], references: [id])
  likes            RouteLike[] // 点赞记录
}

model PendingUser {
  email            String   @id
  displayName      String
  password         String
  verificationCode String
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// 用户关注关系表
model UserFollow {
  id          String   @id @default(uuid())
  followerId  String // 关注者ID
  followingId String // 被关注者ID
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId]) // 防止重复关注
  @@index([followerId])
  @@index([followingId])
}

// 路线点赞表
model RouteLike {
  id        String   @id @default(uuid())
  userId    String // 点赞的用户ID
  routeId   String // 被点赞的路线ID
  createdAt DateTime @default(now())

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  route UserPublishRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([userId, routeId]) // 防止重复点赞
  @@index([userId])
  @@index([routeId])
}
